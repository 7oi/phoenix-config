(()=>{"use strict";function e(e,t){return e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height}const t=new Map;function i(e,t,i){if(Array.isArray(e)){const n=e.map((e=>o(e,t,i)));return()=>n.forEach((e=>e()))}return o(e,t,i)}function o(e,i,o){const n=new Key(e,i,o),s=function(e,t){return e+t.sort().join()}(e,i);return t.set(s,n),()=>function(e){const i=t.get(e);i&&(i.disable(),t.delete(e))}(s)}const n=Object.assign((function(...e){e=e.map((e=>s(e))),Phoenix.log(...e),console.trace(...e)}),{notify:(...e)=>{e=e.map((e=>s(e))),Phoenix.log(...e);const t=e.join(" ");Phoenix.notify(t),console.trace(...e)},noTrace:(...e)=>{e=e.map((e=>s(e))),Phoenix.log(...e),console.log(...e)}});function s(e){if(e instanceof Error){let t="";if(e.stack){const i=e.stack.trim().split("\n");i[0]+=` (:${e.line}:${e.column})`,t="\n"+i.map((e=>"\t at "+e)).join("\n")}return`\n${e.toString()}${t}`}switch(typeof e){case"object":return"\n"+JSON.stringify(e,null,2);case"function":return e.toString();default:return e}}var r;function d(e,t,i=1,o){const s=new Modal;s.text=t,s.duration=i,o&&(s.icon=o),function(e,t){!function(e,t,i,o){const{height:s,width:r,x:d,y:a}=e.frame(),l=t.visibleFrame();e.origin={x:l.x+(l.width/i-r/2),y:l.y+(l.height/o-s/2)},n(e.origin),e.show()}(e,t,2,1+1/3)}(s,e)}!function(e){e[e.NorthWest=0]="NorthWest",e[e.NorthEast=1]="NorthEast",e[e.SouthWest=2]="SouthWest",e[e.SouthEast=3]="SouthEast"}(r||(r={}));const a=App.get("Phoenix")||App.get("Phoenix (Debug)");class l{constructor(e,t){this.workspace=null,this.screen=e,this.id=t}setWorkspace(e){var t,i;(null===(i=null===(t=this.workspace)||void 0===t?void 0:t.screen)||void 0===i?void 0:i.id)===this.id&&(this.workspace.screen=null);let o=w[e];this.workspace=o,o.screen=this}activateWorkspace(e){var t;this.setWorkspace(e);let i=w[e];i.render(),v(i.windows[0]),Phoenix.log(this.id+" "+(null===(t=this.workspace)||void 0===t?void 0:t.id)),this.vlog("Activated")}vlog(e,t=!0){var i;t&&(e+=" "+(null===(i=this.workspace)||void 0===i?void 0:i.id)),d(this.screen,e,1,a&&a.icon())}hideAllApps(){let e=this.screen.frame();this.screen.windows({visible:!0}).forEach((t=>{e.y=e.height,t.setTopLeft(e)}))}}class h{constructor(e){this.windows=[],this.screen=null,this.mainRatio_=.8,this.id=e}set mainRatio(e){this.mainRatio_=Math.max(Math.min(e,.98),0)}get mainRatio(){return this.mainRatio_}garbageCollect(){let e=new Set(Window.all().map((e=>e.hash())));this.windows=this.windows.filter((t=>e.has(t.hash())))}render(){if(this.garbageCollect(),!this.screen)throw new Error("render called without a screen: "+this.id);if(0==this.windows.length)return void this.screen.hideAllApps();let e=this.screen.screen.flippedVisibleFrame();n(e.x+" "+e.y+" "+e.width+" "+e.height);let t=e.width*this.mainRatio_;for(let i=this.windows.length-1;i>=0;i--){let o=this.windows[i],s=Object.assign({},e);if(0===i)this.windows.length>1&&(s.width=t),o.setTopLeft(s),o.setSize(s);else{let n=this.windows.length-1;s.x=e.x+t+1,s.width=e.width-t,s.height=e.height/n,s.y=e.y+e.height/n*(i-1)+1,o.frame().width<s.width&&o.setTopLeft(s),o.setSize(s),o.setTopLeft(s)}n(s.x+" "+s.y+" "+s.width+" "+s.height+" "+o.title()),o.focus()}!function(){var e;let t={workspaces:[],screens:[]};for(let i of u)t.screens.push({id:i.id,workspace:null===(e=i.workspace)||void 0===e?void 0:e.id});for(let e of w)t.workspaces.push({id:e.id,mainRatio:e.mainRatio,windows:e.windows.map((e=>e.hash()))});n("============SAVING============"),Storage.set("state",t)}()}rotate(){let e=this.windows.shift();e&&this.windows.push(e),n(this.windows.map((e=>e.title()))),this.modal("Rotating "),this.render()}modal(e){var t;this.screen&&(null===(t=this.screen)||void 0===t||t.vlog(e))}findIndexByHash(e){return this.windows.findIndex((t=>e===t.hash()))}findIndex(e){return this.findIndexByHash(e.hash())}removeWindow(e){let t=this.findIndex(e);-1!=t&&(this.windows.splice(t,1),this.screen&&this.render())}addWindow(e,t){if(-1!=this.findIndex(e))return void this.modal("Window already on ");let i=c.get(e.hash());i&&i.removeWindow(e),t?this.windows.unshift(e):this.windows.push(e),c.set(e.hash(),this),this.screen&&this.render(),this.modal("Adding window to ")}}let c=new Map;n(Window.all().map((e=>e.hash()+" "+e.title())));let w=[];for(let e=0;e<=9;e++)w.push(new h(e));let f=Window.focused(),u=[];for(let[e,t]of Screen.all().entries())u.push(new l(t,e));!function(){let e=Window.all(),t=Storage.get("state");if(n("============LOADING============"),n(t),t){for(let i of t.workspaces||[]){n("Workspace "+i.id);let t=w[i.id];i.mainRatio&&(t.mainRatio=i.mainRatio);for(let o of i.windows){let i=e.find((e=>e.hash()===o));i&&t.addWindow(i)}}for(let e of t.screens||[])e.workspace&&u[e.id].activateWorkspace(e.workspace)}}();for(let[e,t]of u.entries())t.workspace||t.activateWorkspace(e+1);function p(){let t=Mouse.location();return u.find((i=>{let o=i.screen.flippedFrame();return e(t,o)}))||u[0]}function g(e){let t=Window.focused();t&&(w[e].addWindow(t,!0),W().render())}function v(e){if(!e)return;e.focus();let t=e.frame();n("Focusing: "+e.title()),Mouse.move(k(t))}function m(e,t){return(e+t)/2}function k(e){return{x:m(e.x,e.x+e.width),y:m(e.y,e.y+e.height)}}function W(){var e;let t=p();return n("getActiveWorkspace: screen: "+t.id+" workspace: "+(null===(e=t.workspace)||void 0===e?void 0:e.id)),t.workspace}v(f);const x=["alt"],y=[...x,"shift"];Phoenix.set({daemon:!1,openAtLogin:!0}),i("right",x,(()=>{var e;v(null===(e=u[0].workspace)||void 0===e?void 0:e.windows[0])})),i("right",y,(()=>{let e=u[0].workspace;e&&(g(e.id),v(e.windows[0]))})),i("left",x,(()=>{var e;v(null===(e=u[1].workspace)||void 0===e?void 0:e.windows[0])})),i("left",y,(()=>{let e=u[1].workspace;e&&(g(e.id),v(e.windows[0]))})),i("down",x,(()=>S())),i("j",x,(()=>S())),i("up",x,(()=>S(-1))),i("k",x,(()=>S(-1))),i("h",x,(()=>{W().mainRatio-=.1,W().render()})),i("l",x,(()=>{W().mainRatio+=.1,W().render()})),i("return",y,(()=>{let e=Window.focused();e&&W().addWindow(e)})),i("delete",y,(()=>{let e=Window.focused();e&&W().removeWindow(e)})),i("c",y,(()=>{let e=Window.focused();null==e||e.close()})),i("space",y,(()=>{var e;let t=Window.focused();for(let t of u)null===(e=t.workspace)||void 0===e||e.render(),t.vlog("Rerendered");v(t)})),i("r",x,(()=>{W().rotate()})),i("r",y,(()=>{let e=Mouse.location(),t=u.map((e=>e.workspace)),i=t.shift();t.push(i),n(t.map((e=>e.id))),u.forEach(((e,i)=>{n("setting SCREEN:"+e.id+" WINDOW: "+t[i].id),e.setWorkspace(t[i].id)})),u.forEach((e=>{var t,i;n("rendering SCREEN:"+e.id+" WINDOW: "+(null===(t=e.workspace)||void 0===t?void 0:t.id)),null===(i=e.workspace)||void 0===i||i.render()})),Mouse.move(e)}));for(let e=0;e<=9;e++)i(e.toString(),x,(()=>{let t=w[e];if(t.screen){let e=Window.focused(),i=p();return n(i.id),n(null==e?void 0:e.title()),t.screen!==i?(t.screen.vlog("Here "),i.vlog("Already Showing "+t.id,!1)):i.vlog("This is"),t.render(),void(i===t.screen?(n(i.id),v(t.windows[0])):(n(null==e?void 0:e.title()),v(e)))}p().activateWorkspace(e)})),i(e.toString(),y,(()=>{g(e)}));function S(e=1){let t=Window.focused();if(!t){let e=p();return void(e.workspace&&e.activateWorkspace(e.workspace.id))}let i=t.hash(),o=c.get(i);if(!o)return;let n=o.windows;v(n[(o.findIndex(t)+e+n.length)%n.length])}Event.on("windowDidClose",(e=>{let t=c.get(e.hash());t&&(n("windowDidClose "+e.title()+" APPNAME: "+e.app().name()+" HASH: "+e.hash()+" removing from: "+t.id),t.removeWindow(e))})),Event.on("windowDidOpen",(e=>{e.isVisible()&&!c.get(e.hash())&&(n("windowDidOpen "+e.title()+" APPNAME: "+e.app().name()+" HASH: "+e.hash()),W().id,"Phoenix"!=e.app().name()&&W().addWindow(e,!0))})),Event.on("mouseDidMove",(t=>{let i=Window.recent().find((i=>e(t,i.frame())));null==i||i.focus()})),i("`",x,(()=>{var e,t;for(let i of u)for(let o of(null===(e=i.workspace)||void 0===e?void 0:e.windows)||[]){const e=new Modal;e.text=((null===(t=i.workspace)||void 0===t?void 0:t.id.toString())||"")+" "+o.title(),e.duration=3,e.icon=o.app().icon();let n=e.frame(),s=k(o.frame()),r=i.screen.flippedFrame(),d=s.y-r.y;d=r.height-d,s.x-=n.width/2,s.y=d-n.height+i.screen.frame().y,e.origin=s,e.show()}})),i("`",y,(()=>{let e=Window.focused();if(!e)return;n("============================================================="),n(e.hash()+" - "+e.app.name+" - "+e.title());let t=Storage.get("state");n(t),n("=============================================================")}))})();