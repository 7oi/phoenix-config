(()=>{"use strict";function e(e,i){return e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height}const i=new Map;function t(e,i,t){if(Array.isArray(e)){const o=e.map((e=>n(e,i,t)));return()=>o.forEach((e=>e()))}return n(e,i,t)}function n(e,t,n){const o=new Key(e,t,n),s=function(e,i){return e+i.sort().join()}(e,t);return i.set(s,o),()=>function(e){const t=i.get(e);t&&(t.disable(),i.delete(e))}(s)}const o=Object.assign((function(...e){e=e.map((e=>s(e))),Phoenix.log(...e),console.trace(...e)}),{notify:(...e)=>{e=e.map((e=>s(e))),Phoenix.log(...e);const i=e.join(" ");Phoenix.notify(i),console.trace(...e)},noTrace:(...e)=>{e=e.map((e=>s(e))),Phoenix.log(...e),console.log(...e)}});function s(e){if(e instanceof Error){let i="";if(e.stack){const t=e.stack.trim().split("\n");t[0]+=` (:${e.line}:${e.column})`,i="\n"+t.map((e=>"\t at "+e)).join("\n")}return`\n${e.toString()}${i}`}switch(typeof e){case"object":return"\n"+JSON.stringify(e,null,2);case"function":return e.toString();default:return e}}var r;function d(e,i,t=1,n){const s=new Modal;s.text=i,s.duration=t,n&&(s.icon=n),function(e,i){!function(e,i,t,n){const{height:s,width:r,x:d,y:a}=e.frame(),l=i.visibleFrame();e.origin={x:l.x+(l.width/t-r/2),y:l.y+(l.height/n-s/2)},o(e.origin),e.show()}(e,i,2,1+1/3)}(s,e)}!function(e){e[e.NorthWest=0]="NorthWest",e[e.NorthEast=1]="NorthEast",e[e.SouthWest=2]="SouthWest",e[e.SouthEast=3]="SouthEast"}(r||(r={}));const a=App.get("Phoenix")||App.get("Phoenix (Debug)");class l{constructor(e,i){this.workspace=null,this.screen=e,this.id=i}setWorkspace(e){var i,t;(null===(t=null===(i=this.workspace)||void 0===i?void 0:i.screen)||void 0===t?void 0:t.id)===this.id&&(this.workspace.screen=null);let n=w[e];this.workspace=n,n.screen=this}activateWorkspace(e){var i;this.setWorkspace(e);let t=w[e];t.render(),v(t.windows[0]),Phoenix.log(this.id+" "+(null===(i=this.workspace)||void 0===i?void 0:i.id)),this.vlog("Activated")}vlog(e,i=!0){var t;i&&(e+=" "+(null===(t=this.workspace)||void 0===t?void 0:t.id)),d(this.screen,e,1,a&&a.icon())}hideAllApps(){let e=this.screen.frame();this.screen.windows({visible:!0}).forEach((i=>{e.y=e.height,i.setTopLeft(e)}))}}class h{constructor(e){this.windows=[],this.screen=null,this.mainRatio_=.8,this.id=e}set mainRatio(e){this.mainRatio_=Math.max(Math.min(e,.98),0)}get mainRatio(){return this.mainRatio_}garbageCollect(){let e=new Set(Window.all().map((e=>e.hash())));this.windows=this.windows.filter((i=>e.has(i.hash())))}render(){if(this.garbageCollect(),!this.screen)throw new Error("render called without a screen: "+this.id);if(0==this.windows.length)return void this.screen.hideAllApps();let e=this.screen.screen.flippedVisibleFrame(),i=e.width*this.mainRatio_;for(let t=this.windows.length-1;t>=0;t--){let n=this.windows[t],o=Object.assign({},e);if(0===t)this.windows.length>1&&(o.width=i),n.setTopLeft(o),n.setSize(o);else{let s=this.windows.length-1;o.x=e.x+i+1,o.width=e.width-i,o.height=e.height/s,o.y=e.y+e.height/s*(t-1)+1,n.frame().width<o.width&&n.setTopLeft(o),n.setSize(o),n.setTopLeft(o)}n.focus()}!function(){var e;let i={workspaces:[],screens:[]};for(let t of u)i.screens.push({id:t.id,workspace:null===(e=t.workspace)||void 0===e?void 0:e.id});for(let e of w)i.workspaces.push({id:e.id,mainRatio:e.mainRatio,windows:e.windows.map((e=>e.hash()))});o("============SAVING============"),Storage.set("state",i)}()}spin(){let e=this.windows.shift();e&&this.windows.push(e),o(this.windows.map((e=>e.title()))),this.modal("Spinning "),this.render()}modal(e){var i;this.screen&&(null===(i=this.screen)||void 0===i||i.vlog(e))}findIndexByHash(e){return this.windows.findIndex((i=>e===i.hash()))}findIndex(e){return this.findIndexByHash(e.hash())}removeWindow(e){let i=this.findIndex(e);-1!=i&&(this.windows.splice(i,1),this.screen&&this.render())}addWindow(e,i){if(-1!=this.findIndex(e))return void this.modal("Window already on ");let t=c.get(e.hash());t&&t.removeWindow(e),i?this.windows.unshift(e):this.windows.push(e),c.set(e.hash(),this),this.screen&&this.render(),this.modal("Adding window to ")}}let c=new Map;o(Window.all().map((e=>e.hash()+" "+e.title())));let w=[];for(let e=0;e<=9;e++)w.push(new h(e));let f=Window.focused(),u=[];for(let[e,i]of Screen.all().entries())u.push(new l(i,e));!function(){let e=Window.all(),i=Storage.get("state");if(o("============LOADING============"),o(i),i){for(let t of i.workspaces||[]){o("Workspace "+t.id);let i=w[t.id];t.mainRatio&&(i.mainRatio=t.mainRatio);for(let n of t.windows){let t=e.find((e=>e.hash()===n));t&&i.addWindow(t)}}for(let e of i.screens||[])e.workspace&&u[e.id].activateWorkspace(e.workspace)}}(),u.sort(((e,i)=>e.screen.frame().x-i.screen.frame().x));for(let[e,i]of u.entries())i.workspace||i.activateWorkspace(e+1);function p(){let i=Mouse.location();return u.find((t=>{let n=t.screen.flippedFrame();return e(i,n)}))||u[0]}function g(e){let i=Window.focused();i&&(w[e].addWindow(i,!0),W().render())}function v(e){if(!e)return;e.focus();let i=e.frame();o("Focusing: "+e.title()),Mouse.move(k(i))}function m(e,i){return(e+i)/2}function k(e){return{x:m(e.x,e.x+e.width),y:m(e.y,e.y+e.height)}}function W(){var e;let i=p();return o("getActiveWorkspace: screen: "+i.id+" workspace: "+(null===(e=i.workspace)||void 0===e?void 0:e.id)),i.workspace}v(f);const x=["alt"],y=[...x,"shift"];function S(e=1){var i;let t=u.findIndex((e=>e===p())),n=u[Math.max(0,Math.min(u.length-1,t+e))];(null===(i=n.workspace)||void 0===i?void 0:i.windows.length)?v(n.workspace.windows[0]):Mouse.move(k(n.screen.flippedFrame()))}Phoenix.set({daemon:!1,openAtLogin:!0}),t("right",x,(()=>{S(1)})),t("right",y,(()=>{let e=u[0].workspace;e&&(g(e.id),v(e.windows[0]))})),t("left",x,(()=>{S(-1)})),t("left",y,(()=>{let e=u[1].workspace;e&&(g(e.id),v(e.windows[0]))})),t("down",x,(()=>A())),t("j",x,(()=>A())),t("up",x,(()=>A(-1))),t("k",x,(()=>A(-1))),t("h",x,(()=>{W().mainRatio-=.1,W().render()})),t("l",x,(()=>{W().mainRatio+=.1,W().render()})),t("return",y,(()=>{let e=Window.focused();e&&W().addWindow(e)})),t("delete",y,(()=>{let e=Window.focused();e&&W().removeWindow(e)})),t("c",y,(()=>{let e=Window.focused();null==e||e.close()})),t("space",y,(()=>{var e;let i=Window.focused();for(let i of u)null===(e=i.workspace)||void 0===e||e.render(),i.vlog("Rerendered");v(i)})),t("r",x,(()=>{W().spin()})),t("r",y,(()=>{let e=Mouse.location(),i=u.map((e=>e.workspace)),t=i.shift();i.push(t),o(i.map((e=>e.id))),u.forEach(((e,t)=>{o("setting SCREEN:"+e.id+" WINDOW: "+i[t].id),e.setWorkspace(i[t].id)})),u.forEach((e=>{var i,t;o("rendering SCREEN:"+e.id+" WINDOW: "+(null===(i=e.workspace)||void 0===i?void 0:i.id)),null===(t=e.workspace)||void 0===t||t.render()})),Mouse.move(e)}));for(let e=0;e<=9;e++)t(e.toString(),x,(()=>{let i=w[e];if(i.screen){let e=Window.focused(),t=p();return o(t.id),o(null==e?void 0:e.title()),i.screen!==t?(i.screen.vlog("Here "),t.vlog("Already Showing "+i.id,!1)):t.vlog("This is"),i.render(),void(t===i.screen?(o(t.id),v(i.windows[0])):(o(null==e?void 0:e.title()),v(e)))}p().activateWorkspace(e)})),t(e.toString(),y,(()=>{g(e)}));function A(e=1){let i=Window.focused();if(!i){let e=p();return void(e.workspace&&e.activateWorkspace(e.workspace.id))}let t=i.hash(),n=c.get(t);if(!n)return;let o=n.windows;v(o[(n.findIndex(i)+e+o.length)%o.length])}Event.on("windowDidClose",(e=>{let i=c.get(e.hash());i&&(o("windowDidClose "+e.title()+" APPNAME: "+e.app().name()+" HASH: "+e.hash()+" removing from: "+i.id),i.removeWindow(e))})),Event.on("windowDidOpen",(e=>{e.isVisible()&&!c.get(e.hash())&&(o("windowDidOpen "+e.title()+" APPNAME: "+e.app().name()+" HASH: "+e.hash()),W().id,"Phoenix"!=e.app().name()&&W().addWindow(e,!0))})),Event.on("mouseDidMove",(i=>{if(i.modifiers.find((e=>e===x[0])))return;let t=Window.recent().find((t=>e(i,t.frame())));null==t||t.focus()})),t("`",x,(()=>{var e,i;for(let t of u)for(let n of(null===(e=t.workspace)||void 0===e?void 0:e.windows)||[]){const e=new Modal;e.text=((null===(i=t.workspace)||void 0===i?void 0:i.id.toString())||"")+" "+n.title(),e.duration=3,e.icon=n.app().icon();let o=e.frame(),s=k(n.frame()),r=t.screen.flippedFrame(),d=s.y-r.y;d=r.height-d,s.x-=o.width/2,s.y=d-o.height+t.screen.frame().y,e.origin=s,e.show()}})),t("`",y,(()=>{let e=Window.focused();if(!e)return;o("============================================================="),o(e.hash()+" - "+e.app.name+" - "+e.title());let i=Storage.get("state");o(i),o("=============================================================")}))})();